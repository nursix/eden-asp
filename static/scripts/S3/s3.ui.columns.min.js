/*
 2025 (c) Sahana Software Foundation
 @license MIT
*/
(function(c,p){var m=0;c.widget("s3.variableColumns",{options:{},_create:function(){this.id=m;m+=1;this.eventNamespace=".variableColumns";this.columnConfigs={}},_init:function(){var a=c(this.element).closest("form.dt-wrapper");this.availableColumns=a=c(".column-selector",a);this.configsURL=a.data("url");this.refresh()},_destroy:function(){this._unbindEvents()},refresh:function(){this._unbindEvents();this._bindEvents()},_openDialog:function(){const a=this.availableColumns;if(a.length){var b=c('<div class="column-select-container">').hide().appendTo(c("body")),
d=this;a.first().clone().removeClass("hide").show().appendTo(b);var e=b.show().dialog({title:i18n.selectColumns,autoOpen:!1,minHeight:480,maxHeight:640,minWidth:320,modal:!0,closeText:"",open:function(){d._bindDialogEvents(e,b);c(".column-options",b).sortable({placeholder:"sortable-placeholder",forcePlaceholderSize:!0});d._initConfigManager(b)},close:function(){d._removeDialogEvents(b);c(".column-options",b).sortable("destroy");b.hide().remove()}});e.dialog("open")}},_applyColumnSelection:function(a,
b){const d=document.createElement("a");d.href=window.location.href;const e=new URLSearchParams(d.search);e.delete("aCols");if(!b){const f=[];c(".column-select:checked",a).each(function(){f.push(c(this).data("index"))});f.length&&e.append("aCols",f.join(","))}d.search=e.toString();window.location.href=d.href},_updateColumnSelection:function(a,b){a=c("tbody.column-options",a);a=c("tr",a);const d={},e=Array.from(b.columns);var f;const k=function(g){for(f=g;e.length&&d.hasOwnProperty(e[0]);){g=e[0];let h=
d[g];h.insertAfter(f);f=h;delete d[g];e.splice(0,1)}};a.each(function(){let g=c(this),h=c("input.column-select",g),l=h.data("selector"),n=e.indexOf(l);f=g;-1==n?h.prop("checked",!1):0==n?(h.prop("checked",!0),e.splice(0,1),k(g)):(h.prop("checked",!0),g.detach(),d[l]=g)});k(f)},_initConfigManager:function(a){var b=this.configsURL;if(b){var d=c(".cfg-select-options",a);c.ajaxS3({url:b,type:"GET",dataType:"json",retryLimit:0,success:function(e){(e=e.configs)&&e.length&&(d.empty(),c("<option>").val("").text("Saved Configurations...").prop("disabled",
!0).prop("selected",!0).appendTo(d),e.forEach(function(f){c("<option>").val(f.id).text(f.name).appendTo(d)}))},error:function(){}});this._bindConfigManagerEvents(a)}},_loadConfig:function(a,b){const d=this.columnConfigs;if(d.hasOwnProperty(b))this._updateColumnSelection(a,d[b]);else{var e=this.configsURL;if(e){var f=this;c.ajaxS3({url:e+"?load="+b,type:"GET",dataType:"json",retryLimit:0,success:function(k){d[k.id]=k;f._updateColumnSelection(a,k)},error:function(){}})}}},_deleteConfig:function(a){const b=
this.configsURL;if(b){var d=c(".cfg-select-options",a),e=c("option:selected",d),f=e.val();a=e.text().trim();if(f&&a&&confirm('Delete "'+a+'"?')){const k=this;c.ajaxS3({url:b+"?delete="+f,type:"DELETE",dataType:"json",retryLimit:0,success:function(g){d.val("");e.remove();delete k.columnConfigs[f]},error:function(){}})}}},_toggleConfigSave:function(a,b){const d=c(".cfg-select",a),e=c(".cfg-save",a),f=c(".cfg-select-options",a);a=c("input.cfg-save-name",a);if(b){b=c("option:selected",f);let k="",g=0;
f.val()&&(k=b.text().trim(),g=2*k.length);d.hide();e.removeClass("hide").show();a.val(k).focus();a[0].setSelectionRange(g,g)}else a.val(""),e.hide(),d.removeClass("hide").show()},_saveConfig:function(a){const b=this,d=this.configsURL;if(d){var e=c("input.cfg-save-name",a).val().trim();if(e){var f=[];c(".column-select:checked",a).each(function(){f.push(c(this).data("selector"))});if(f.length){var k=this.columnConfigs,g=c(".cfg-select-options",a);c.ajaxS3({url:d,type:"POST",data:JSON.stringify({name:e,
columns:f}),dataType:"json",retryLimit:0,success:function(h){if(h=h.updated||h.created){k[h]=f;var l=c('option[value="'+h+'"]',g);l.length?l.prop("selected",!0):c("<option>").val(h).text(e).appendTo(g).prop("selected",!0);g.val(h)}b._toggleConfigSave(a,!1)},error:function(){b._toggleConfigSave(a,!1)}})}}}},_bindDialogEvents:function(a,b){const d=this.eventNamespace,e=this;c(".ui-widget-overlay").off(d).on("click"+d,function(){a.dialog("close")});c(".cancel-form-btn",b).off(d).on("click"+d,function(){a.dialog("close")});
c(".submit-form-btn",b).off(d).on("click"+d,function(){c(".column-select:checked",b).length&&(e._applyColumnSelection(b),a.dialog("close"))});c(".reset-form-btn",b).off(d).on("click"+d,function(){e._applyColumnSelection(b,!0)});c(".column-left",b).off(d).on("click"+d,function(){c(this).closest("tr").insertBefore(row.prev())});c(".column-right",b).off(d).on("click"+d,function(){c(this).closest("tr").insertAfter(row.next())});c(".column-select-all",b).off(d).on("change"+d,function(){let f=c(this).prop("checked");
c(".column-select",b).prop("checked",f)});c(".column-select",b).off(d).on("change"+d,function(){let f=c(".column-select:not(:checked)",b).length;c(".column-select-all",b).prop("checked",!f)})},_bindConfigManagerEvents:function(a){const b=this.eventNamespace,d=this;c(".cfg-select-options",a).off(b).on("change"+b,function(){let e=c(this).val();e&&d._loadConfig(a,e-0)});c(".cfg-select-save",a).off(b).on("click"+b,function(){d._toggleConfigSave(a,!0)});c(".cfg-select-delete",a).off(b).on("click"+b,function(){d._deleteConfig(a)});
c(".cfg-save-name",a).off(b).on("keyup"+b,function(){});c(".cfg-save-submit",a).off(b).on("click"+b,function(){d._saveConfig(a)});c(".cfg-save-cancel",a).off(b).on("click"+b,function(){d._toggleConfigSave(a,!1)})},_removeDialogEvents:function(a){const b=this.eventNamespace;c(".ui-widget-overlay").off(b);c(".cancel-form-btn, .submit-form-btn, .reset-form-button",a).off(b);c(".column-left, .column-right",a).off(b);c(".column-select, .column-select-all",a).off(b);c(".cfg-select-options, .cfg-select-save, .cfg-select-delete",
a).off(b);c(".cfg-save-name, .cfg-save-submit, .cfg-save-cancel",a).off(b)},_bindEvents:function(){const a=this,b=this.eventNamespace;c(this.element).on("click"+b,function(){a._openDialog()});return!0},_unbindEvents:function(){const a=this.eventNamespace;this._removeDialogEvents(c(".column-select-container"));c(this.element).off(a);return!0}})})(jQuery);
